## 强制缓存

```
# 缓存命中
客户端 --> 客户端缓存库：请求资源
客户端缓存库 --> 客户端：有缓存资源，且未失效，返回资源

# 缓存未命中
客户端 --> 客户端缓存库：请求资源
客户端缓存库 --> 客户端：无缓存资源，或缓存已失效
客户端 --> 服务器：请求资源
服务器 --> 客户端：返回最新资源和缓存规则
客户端 --> 客户端缓存库：存入资源和缓存规则
```

### 字段说明

#### Expires

> 服务端返回的资源过期时间  
> from http@1.0

当请求再次发起的时间小于此时间，则直接使用缓存资源。

服务器时间和客户端时间存在的误差导致了缓存命中误差，现使用 Cache-Control 替代。

#### Cache-Control

1. private 客户端可以缓存
2. public 客户端和代理服务器都可以缓存
3. max-age=xxx 缓存资源将在 xxx 秒后失效
4. **no-cache 需要使用协商缓存来验证缓存资源**
5. no-store 所有内容都不会缓存

## 协商缓存

> 区别就在于有一个请求标识并且向服务端验证的过程

浏览器第一次对一个资源发起请求时，服务器会将缓存标识与资源一起返回，给客户端，再次请求时，客户端会将缓存标识发送给服务器，服务器若判断资源未失效，则返回 304 状态码，客户端直接使用缓存资源，服务端若判断资源失效，则直接返回新的资源和缓存标识。

```
# 缓存命中
客户端 --> 客户端缓存库：请求资源标识
客户端缓存库 --> 客户端：返回资源标识
客户端 --> 服务器：请求服务器验证该标识是否失效
服务器 --> 客户端：通知客户端资源未失效（返回 code: 304）
客户端 --> 客户端缓存库：获取资源

# 缓存未命中
客户端 --> 客户端缓存库：请求资源标识
客户端缓存库 --> 客户端：返回资源标识
客户端 --> 服务器：请求服务器验证该标识是否失效
服务器 --> 客户端：返回最新资源和缓存规则
客户端 --> 客户端缓存库：存入资源和缓存规则
```

### 字段说明

#### Last-Modified & if-Modified-Since & If-Unmodified-Since

##### Last-Modified

服务器在响应请求时，会告诉浏览器资源的最后修改时间。

##### if-Modified-Since

浏览器在此请求服务器的时候头部会带上此字段，后面的值是缓存中获取到的最后修改时间。服务端发现该字段会对比资源的最后修改时间，如果一致，则返回 304，浏览器从缓存中读取资源。

1. 如果文件被修改，返回一个资源，状态码 200
2. 如果没有被修改，状态码 304

##### If-Unmodified-Since

<!-- If-Unmodified-Since:
从字面上看, 就是说: 从某个时间点算起, 是否文件没有被修改

如果没有被修改:则开始`继续'传送文件: 服务器返回: 200 OK
如果文件被修改:则不传输,服务器返回: 412 Precondition failed (预处理错误)

这两个的区别是一个是修改了才下载一个是没修改才下载。
Last-Modified 说好却也不是特别好，因为如果在服务器上，一个资源被修改了，但其实际内容根本没发生改变，会因为Last-Modified时间匹配不上而返回了整个实体给客户端（即使客户端缓存里有个一模一样的资源）。为了解决这个问题，HTTP1.1推出了Etag。 -->

#### Etag & If-None-Match

##### Etag

服务器响应请求时，通过此字段告诉浏览器当前资源在服务器生成的唯一标识。

##### If-None-Match

浏览器在此请求服务器时，浏览器的请求头部会包含此字段，后端的值为在缓存中获取的标识，服务器将对比 If-None-Match 和被请求资源的唯一标识。

1. 不同，说明资源被改动过，响应整个资源内容，状态码 200
2. 相同，说明资源未被修改，状态码 304

但是实际应用中由于 Etag 的计算是使用算法得出来的，而算法会占用服务端计算资源，所以很少使用 Etag。

## TIP

两种缓存机制可以同时存在，强制缓存的优先级高于协商缓存，当执行强制缓存时，如果缓存命中，则直接使用缓存库的资源，不再进行协商缓存。

强制缓存在 Network 里面的显示状态码是 200，Size 是 from memory cache 或者 from disk cache

协商缓存在 Network 里面的显示状态码是 304，Size 是有值的，因为需要发送数据到服务端对比资源是否发生改变

![](https://user-gold-cdn.xitu.io/2018/11/20/167303065d479eaf?imageslim)

![](https://user-gold-cdn.xitu.io/2018/12/17/167bacf5dcc9252f?imageslim)

### 分布式系统

分布式系统里多台服务器之间的文件的 Last-Modified 必须保持一致，以免负载均衡到不同服务器导致对比结果不一致。

分布式系统尽量关闭 ETag，因为每台机器生成的 ETag 会不一样。

## 参考

[alloyteam](http://www.alloyteam.com/2012/03/web-cache-3-how-to-build-cacheable-website/)

[MDN](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Caching)

[SRI 资源安全性](http://www.alloyteam.com/2021/01/sri/)

web 安全

web 错误处理

https://github.com/joeyguo/blog/issues/13

https://github.com/joeyguo/blog/issues/14

web 缓存